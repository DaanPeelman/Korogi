version: "2.4"
services:
  reverse-proxy:
    image: "nginx:1.19-alpine"
    restart: on-failure
    depends_on:
      - korogi-api
      - korogi-web
    links:
      - korogi-api:korogi-api
      - korogi-web:korogi-web
    volumes:
    - ./delivery/reverse-proxy/config/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 8080:80
  postgres:
    image: "postgres:12-alpine"
    restart: on-failure
    ports:
      - 5432:5432
    volumes:
      - ./postgresql:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=korogi
      - POSTGRES_PASSWORD=korogi
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U korogi"]
      interval: 2s
      timeout: 5s
      retries: 10
  korogi-api:
    image: "korogi-api"
    depends_on:
      postgres:
        condition: service_healthy
    restart: always
    build: delivery/korogi-api
    volumes:
      - ./delivery/korogi-api/secrets:/etc/secrets:ro
      - ./logs:/opt/logs
    links:
      - postgres:korogi-postgres
  korogi-web:
    image: "korogi-web"
    restart: always
    build: delivery/korogi-web